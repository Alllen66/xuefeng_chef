{% extends "base.html" %}

{% block title %}èœè°±è¯¦æƒ…{% endblock %}

{% block content %}
<div class="detail-container">
    <button onclick="window.history.back()" class="back-button">&laquo; è¿”å›</button>
    <div id="recipe-detail-content">
        <p class="loading-placeholder">æ­£åœ¨åŠ è½½èœè°±è¯¦æƒ…...</p>
        <!-- è¯¦ç»†ä¿¡æ¯å°†é€šè¿‡ JavaScript åŠ¨æ€åŠ è½½ -->
    </div>
</div>
{% endblock %}

{% block scripts_extra %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const recipeDetailContent = document.getElementById('recipe-detail-content');
            const recordId = "{{ item_id }}"; 

            // Function to render rating stars/hearts
            function renderRating(rating) {
                const maxRating = 5;
                let ratingHtml = '';
                const numericRating = parseFloat(rating);

                if (!isNaN(numericRating) && numericRating >= 0) {
                    for (let i = 1; i <= maxRating; i++) {
                        if (i <= numericRating) {
                            ratingHtml += '<span class="rating-heart filled">â¤ï¸</span>'; // å®å¿ƒ
                        } else if (i - 0.5 <= numericRating) {
                            ratingHtml += '<span class="rating-heart half">ğŸ§¡</span>'; // å¯ç”¨åŠå¿ƒå­—ç¬¦æˆ–ä¸åŒé¢œè‰²è¡¨ç¤ºåŠè¯„
                        } else {
                            ratingHtml += '<span class="rating-heart empty">ğŸ¤</span>'; // ç©ºå¿ƒ
                        }
                    }
                    return `<div class="rating-container">${ratingHtml} <span class="rating-text">(${numericRating.toFixed(1)})</span></div>`;
                }
                return '<div class="rating-container"><span class="rating-text">æš‚æ— è¯„åˆ†</span></div>';
            }


            if (recordId) {
                fetch(`{{ url_for('api_get_recipe_detail', record_id='RECORD_ID_PLACEHOLDER') }}`.replace('RECORD_ID_PLACEHOLDER', recordId))
                    .then(response => {
                        if (!response.ok) {
                            return response.json().then(errData => {
                                throw new Error(errData.error || `HTTP error! status: ${response.status}`);
                            }).catch(() => {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            });
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.error) {
                            recipeDetailContent.innerHTML = `<p>åŠ è½½è¯¦æƒ…å¤±è´¥: ${data.error}</p>`;
                            return;
                        }
                        
                        if (typeof data !== 'object' || data === null || typeof data.fields !== 'object' || data.fields === null) {
                            console.error('Error: API response for recipe detail is not in expected format or "fields" is missing/invalid.', data);
                            recipeDetailContent.innerHTML = '<p>åŠ è½½èœè°±è¯¦æƒ…å¤±è´¥ï¼šæ”¶åˆ°çš„æ•°æ®æ ¼å¼ä¸æ­£ç¡®ã€‚</p>';
                            return;
                        }
                        
                        const fields = data.fields;
                        document.title = (fields['èœå'] || 'èœè°±è¯¦æƒ…') + " - ç¾é£Ÿæ¨è";

                        console.log("èœè°±è¯¦æƒ…æ•°æ® (fields):", fields);

                        let imageUrl = "{{ url_for('static', filename='images/default_food.png') }}";
                        if (fields['å›¾ç‰‡é“¾æ¥'] && Array.isArray(fields['å›¾ç‰‡é“¾æ¥']) && fields['å›¾ç‰‡é“¾æ¥'].length > 0) {
                            const firstUrl = fields['å›¾ç‰‡é“¾æ¥'][0];
                            if (typeof firstUrl === 'string' && firstUrl.trim() !== '') {
                                imageUrl = firstUrl.trim();
                            }
                        }

                        // å¤„ç† AI æ ‡ç­¾ (ç§»åˆ°æ ‡é¢˜ä¸‹æ–¹)
                        let tagsDisplayHtml = '';
                        if (fields['DeepSeek æ ‡ç­¾.è¾“å‡ºç»“æœ']) {
                            let tagsArray = [];
                            if (Array.isArray(fields['DeepSeek æ ‡ç­¾.è¾“å‡ºç»“æœ'])) {
                                tagsArray = fields['DeepSeek æ ‡ç­¾.è¾“å‡ºç»“æœ'].filter(tag => typeof tag === 'string' && tag.trim() !== '');
                            } else if (typeof fields['DeepSeek æ ‡ç­¾.è¾“å‡ºç»“æœ'] === 'string') {
                                // å¦‚æœæ˜¯å•ä¸ªå­—ç¬¦ä¸²ï¼Œå¯ä»¥æŒ‰æ¢è¡Œç¬¦æˆ–é€—å·åˆ†å‰²
                                tagsArray = fields['DeepSeek æ ‡ç­¾.è¾“å‡ºç»“æœ'].split(/[\n,]+/).map(tag => tag.trim()).filter(tag => tag);
                            }
                            
                            if (tagsArray.length > 0) {
                                tagsDisplayHtml = '<div class="tags-section">';
                                tagsArray.forEach(tag => {
                                    tagsDisplayHtml += `<span class="recipe-tag">${tag}</span>`;
                                });
                                tagsDisplayHtml += '</div>';
                            }
                        }
                        
                        // å¤„ç†æŠ–éŸ³è§†é¢‘é“¾æ¥ (ä¸å†åˆ›å»ºç‹¬ç«‹åŒºåŸŸï¼Œè€Œæ˜¯å‡†å¤‡ä¸€ä¸ªé“¾æ¥å­—ç¬¦ä¸²)
                        let douyinLinkButtonHtml = ''; // ç”¨äºå­˜å‚¨æŠ–éŸ³æŒ‰é’®çš„HTML
                        if (fields['æŠ–éŸ³é“¾æ¥'] && typeof fields['æŠ–éŸ³é“¾æ¥'] === 'string') {
                            const douyinUrl = fields['æŠ–éŸ³é“¾æ¥'].trim();
                            if (douyinUrl.startsWith("http")) { 
                                // åªç”ŸæˆæŒ‰é’®çš„HTMLï¼Œä¸åŒ…å«å¤–å±‚å®¹å™¨å’Œâ€œç›¸å…³è§†é¢‘â€æ–‡å­—
                                douyinLinkButtonHtml = `<a href="${douyinUrl}" target="_blank" class="douyin-button">ç‚¹å‡»è§‚çœ‹æŠ–éŸ³è§†é¢‘</a>`;
                            }
                        }
                        
                        // å¤„ç†å¤‡æ³¨ (ç¡®ä¿æ˜¯å­—ç¬¦ä¸²)ï¼Œå¹¶åœ¨è¿™é‡Œæ•´åˆæŠ–éŸ³é“¾æ¥
                        let remarksHtml = '';
                        if (fields['å¤‡æ³¨'] || douyinLinkButtonHtml) { // å¦‚æœæœ‰å¤‡æ³¨å†…å®¹æˆ–æŠ–éŸ³é“¾æ¥
                            let remarksContent = '';
                            if (fields['å¤‡æ³¨']) {
                                if (Array.isArray(fields['å¤‡æ³¨'])) {
                                    remarksContent = fields['å¤‡æ³¨'].join('<br>');
                                } else if (typeof fields['å¤‡æ³¨'] === 'string') {
                                    remarksContent = fields['å¤‡æ³¨'].replace(/\n/g, '<br>');
                                }
                            }

                            // å¦‚æœæœ‰æŠ–éŸ³é“¾æ¥æŒ‰é’®ï¼Œå¹¶ä¸”æœ‰å¤‡æ³¨å†…å®¹ï¼Œåˆ™åœ¨å¤‡æ³¨åæ·»åŠ ï¼›å¦åˆ™ï¼Œå¦‚æœåªæœ‰æŠ–éŸ³é“¾æ¥ï¼Œåˆ™ç›´æ¥ä½¿ç”¨
                            if (douyinLinkButtonHtml) {
                                if (remarksContent) {
                                    remarksContent += `<br><br>${douyinLinkButtonHtml}`; // åœ¨å¤‡æ³¨å†…å®¹ååŠ ä¸¤è¡Œæ¢è¡Œå†åŠ æŒ‰é’®
                                } else {
                                    remarksContent = douyinLinkButtonHtml; // å¦‚æœæ²¡æœ‰å¤‡æ³¨ï¼Œå¤‡æ³¨åŒºå°±åªæ˜¾ç¤ºæŠ–éŸ³æŒ‰é’®
                                }
                            }
                            
                            if (remarksContent) { // ç¡®ä¿æœ€ç»ˆæœ‰å†…å®¹æ‰åˆ›å»ºå¤‡æ³¨åŒºåŸŸ
                                remarksHtml = `<h2>å¤‡æ³¨</h2><div class="detail-section">${remarksContent}</div>`;
                            }
                        }
                        
                        // Helper function to safely get and format text content
                        function getFormattedText(fieldValue) {
                            if (Array.isArray(fieldValue)) {
                                return fieldValue.join('<br>');
                            }
                            if (typeof fieldValue === 'string') {
                                return fieldValue.replace(/\n/g, '<br>');
                            }
                            return 'æš‚æ— ä¿¡æ¯';
                        }

                        recipeDetailContent.innerHTML = `
                            <img src="${imageUrl}" alt="${fields['èœå'] || 'ç¾é£Ÿå›¾ç‰‡'}" class="detail-image" onerror="this.onerror=null;this.src='{{ url_for('static', filename='images/default_food.png') }}';">
                            <h1>${fields['èœå'] || 'æœªçŸ¥èœå'}</h1>
                            ${tagsDisplayHtml}
                            <div class="detail-meta">
                                ${renderRating(fields['è¯„åˆ†'])}
                                <span><i class="fas fa-clock"></i> çƒ¹é¥ªæ—¶é—´: ${fields['çƒ¹é¥ªæ—¶é—´'] || 'æœªçŸ¥'}</span>
                            </div>
                            

                            <h2>ææ–™æ¸…å•</h2>
                            <div class="detail-section">${getFormattedText(fields['ææ–™'])}</div>
                            
                            <h2>åšæ³•æ­¥éª¤</h2>
                            <div class="detail-section">${getFormattedText(fields['åšæ³•'])}</div>
                            
                            ${remarksHtml}
                        `;
                    })
                    .catch(error => {
                        console.error('Error fetching recipe detail:', error);
                        recipeDetailContent.innerHTML = `<p>åŠ è½½èœè°±è¯¦æƒ…æ—¶å‡ºé”™ï¼Œè¯·ç¨åé‡è¯•ã€‚(${error.message || 'æœªçŸ¥é”™è¯¯'})</p>`;
                    });
            } else {
                recipeDetailContent.innerHTML = '<p>æœªæä¾›èœè°±IDã€‚</p>';
            }
        });
    </script>
{% endblock %}